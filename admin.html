<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | The Minum</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Poppins:wght@500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

    <!-- Login Modal -->
    <div id="login-modal">
        <div class="login-box">
            <a href="index.html" class="close-modal" style="text-decoration: none;">&times;</a>
            <h2>Admin Login</h2>
            <p>Enter password to access dashboard</p>
            <div class="password-wrapper">
                <input type="password" id="admin-password" placeholder="Password">
                <span class="toggle-password-icon" onclick="togglePasswordVisibility()">üëÅÔ∏è</span>
            </div>
            <button class="cta-button button-primary" onclick="checkLogin()">Login</button>
            <p id="login-error" style="color: red; margin-top: 10px; display: none;">Incorrect Password</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="admin-dashboard" class="admin-container" style="display: none;">
        <header class="admin-header">
            <div>
                <h2>Admin Dashboard</h2>
                <p>Manage your store</p>
            </div>
            <div>
                <button class="refresh-btn" onclick="refreshCurrentView()">‚Üª Refresh</button>
                <button class="cta-button" onclick="logout()"
                    style="margin-left: 10px; background-color: #f44336; color: white;">Logout</button>
                <a href="index.html" class="button-secondary" style="margin-left: 10px;">Back to Site</a>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="admin-nav">
            <button class="nav-tab active" onclick="switchTab('orders')">Orders</button>
            <button class="nav-tab" onclick="switchTab('products')">Products</button>
            <button class="nav-tab" onclick="switchTab('vacancies')">Vacancies</button>
            <button class="nav-tab" onclick="switchTab('applicants')">Applicants</button>
            <button class="nav-tab" onclick="switchTab('staff')">Staff</button>
        </div>

        <!-- Orders View -->
        <div id="view-orders" class="dashboard-view">
            <div class="orders-card">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products View -->
        <div id="view-products" class="dashboard-view" style="display: none;">
            <!-- Product Stats & Action Bar -->
            <div class="action-bar"
                style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div class="product-stats">
                    <span id="product-count-badge"
                        style="background: var(--primary-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600;">Total
                        Products: 0</span>
                </div>
                <button class="cta-button button-primary" onclick="openProductModal()">+ Add New Product</button>
            </div>

            <!-- Enhanced Search & Filter Bar -->
            <div class="filter-bar"
                style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div class="filter-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 5px;">Search
                        Name</label>
                    <input type="text" id="admin-product-search" placeholder="Search by name..."
                        onkeyup="filterProductsAdmin()" style="padding: 10px 15px;">
                </div>
                <div class="filter-group" style="min-width: 150px;">
                    <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 5px;">Category</label>
                    <select id="admin-category-filter" onchange="filterProductsAdmin()" style="padding: 10px 15px;">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div class="filter-group" style="min-width: 150px;">
                    <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 5px;">Price
                        Range</label>
                    <select id="admin-price-filter" onchange="filterProductsAdmin()" style="padding: 10px 15px;">
                        <option value="all">All Prices</option>
                        <option value="0-5">Under RM5</option>
                        <option value="5-10">RM5 - RM10</option>
                        <option value="10-20">RM10 - RM20</option>
                        <option value="20">Above RM20</option>
                    </select>
                </div>
                <div class="filter-group" style="min-width: 150px;">
                    <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 5px;">Sort By</label>
                    <select id="admin-product-sort" onchange="filterProductsAdmin()" style="padding: 10px 15px;">
                        <option value="default">Default (Newest)</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name-asc">Name: A-Z</option>
                    </select>
                </div>
                <button class="refresh-btn" onclick="clearProductFilters()" style="margin-bottom: 2px;">Reset</button>
            </div>

            <div class="orders-card">
                <div class="table-responsive">
                    <table id="admin-products-table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Vacancies View -->
    <div id="view-vacancies" class="dashboard-view" style="display: none;">
        <div class="action-bar" style="margin-bottom: 20px; text-align: right;">
            <button class="cta-button button-primary" onclick="openVacancyModal()">+ Add New Vacancy</button>
        </div>
        <div class="orders-card">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Applicants</th>
                            <th>Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vacancies-table-body">
                        <!-- Vacancies will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Applicants View -->
    <div id="view-applicants" class="dashboard-view" style="display: none;">
        <div class="orders-card">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Position</th>
                            <th>Contact</th>
                            <th>College</th>
                            <th>Transport</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applicants-table-body">
                        <!-- Applicants will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Staff View -->
    <div id="view-staff" class="dashboard-view" style="display: none;">
        <div class="orders-card">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Transport</th>
                            <th>Resident</th>
                            <th>What unit</th>
                            <th>Working since</th>
                            <th>Ended work</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table-body">
                        <!-- Staff will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeProductModal()">&times;</span>
            <h2 id="modal-title">Add Product</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">

                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="p-name" required>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="p-category-select" onchange="checkCategoryInput(this)">
                        <option value="">Select Category...</option>
                        <option value="new">+ Type New Category</option>
                    </select>
                    <input type="text" id="p-category-new" placeholder="Enter new category name"
                        style="display: none; margin-top: 5px;">
                </div>

                <div class="form-group">
                    <label>Price (RM)</label>
                    <input type="number" id="p-price" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Image Path (URL or local path)</label>
                    <input type="text" id="p-image" placeholder="images/matchalatte.png">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="p-description" rows="3"></textarea>
                </div>

                <button type="submit" class="cta-button button-primary">Save Product</button>
            </form>
        </div>
    </div>

    <!-- Vacancy Modal -->
    <div id="vacancy-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeVacancyModal()">&times;</span>
            <h2 id="vacancy-modal-title">Add Vacancy</h2>
            <form id="vacancy-form">
                <input type="hidden" id="vacancy-id">
                <div class="form-group">
                    <label>Job Title</label>
                    <input type="text" id="v-title" required placeholder="e.g. Barista">
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="v-type">
                        <option value="Part Time">Part Time</option>
                        <option value="Full Time">Full Time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description (Job Details)</label>
                    <textarea id="v-description" rows="10" required placeholder="Job Description"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="v-status">
                        <option value="Active">Active (Visible)</option>
                        <option value="Closed">Closed (Hidden)</option>
                    </select>
                </div>
                <button type="submit" class="cta-button button-primary">Save Vacancy</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA03gmfkZFjWauZR9uza-TkTrTuAPWsUFg",
            authDomain: "theminums.firebaseapp.com",
            projectId: "theminums",
            storageBucket: "theminums.firebasestorage.app",
            messagingSenderId: "130106351120",
            appId: "1:130106351120:web:458a2576f99cef54b4b495"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentTab = 'orders';
        let allCategories = new Set(); // To track unique categories

        // Password Toggle
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('admin-password');
            const icon = document.querySelector('.toggle-password-icon');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'üôà'; // Change icon to 'hide'
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'üëÅÔ∏è'; // Change icon to 'show'
            }
        }

        // 1. Login Logic
        // 1. Login Logic & Session Handling
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                showDashboard();
            }
        });

        function showDashboard() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            // Default load
            if (typeof fetchOrders === 'function') fetchOrders();
        }

        function checkLogin() {
            const password = document.getElementById('admin-password').value;
            if (password === 'admin123') {
                localStorage.setItem('adminLoggedIn', 'true');
                showDashboard();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminLoggedIn');
                window.location.reload();
            }
        }

        // 2. Navigation
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');

            document.querySelectorAll('.dashboard-view').forEach(v => v.style.display = 'none');
            document.getElementById(`view-${tab}`).style.display = 'block';

            refreshCurrentView();
        }

        function refreshCurrentView() {
            if (currentTab === 'orders') fetchOrders();
            if (currentTab === 'products') fetchProducts();
            if (currentTab === 'vacancies') fetchVacancies();
            if (currentTab === 'applicants') fetchApplicants();
            if (currentTab === 'staff') fetchStaff();
        }

        // 3. fetch Orders
        function fetchOrders() {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';

            db.collection("orders").orderBy("createdAt", "desc").get().then((snap) => {
                tbody.innerHTML = '';
                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No orders found.</td></tr>';
                    return;
                }
                snap.forEach(doc => renderOrderRow(doc.id, doc.data(), tbody));
            });
        }

        function renderOrderRow(id, order, container) {
            let dateStr = order.createdAt && order.createdAt.toDate ? order.createdAt.toDate().toLocaleString() : 'N/A';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>#${id.slice(-6).toUpperCase()}</strong></td>
                <td>${dateStr}</td>
                <td>${order.customer.name}<br><span style="font-size:0.85rem;color:#777;">${order.customer.phone}</span></td>
                <td>RM${order.totals.grandTotal.toFixed(2)}</td>
                <td><span class="status-badge status-new">${order.status || 'New'}</span></td>
                <td><button class="toggle-btn" onclick="toggleDetails('${id}')">Details</button></td>
            `;
            container.appendChild(tr);

            // Details Row
            const trD = document.createElement('tr');
            trD.id = `details-${id}`;
            trD.className = 'order-details-row';
            trD.style.display = 'none';
            let itemsHtml = order.items.map(i => `<li><span>${i.quantity}x ${i.name}</span><span>RM${(i.price * i.quantity).toFixed(2)}</span></li>`).join('');
            trD.innerHTML = `
                <td colspan="6" class="details-content">
                    <div class="details-grid">
                        <div class="detail-group"><h4>Address</h4><p>${order.customer.address}</p></div>
                        <div class="detail-group"><h4>Items</h4><ul class="order-items-list">${itemsHtml}</ul></div>
                    </div>
                </td>`;
            container.appendChild(trD);
        }

        function toggleDetails(id) {
            const el = document.getElementById(`details-${id}`);
            el.style.display = el.style.display === 'none' ? 'table-row' : 'none';
        }

        // 4. Product Management
        let adminProducts = []; // Local cache for filtering

        function fetchProducts() {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';

            db.collection("products").get().then((snap) => {
                adminProducts = [];
                allCategories.clear();

                snap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    adminProducts.push(data);
                    if (data.category) allCategories.add(data.category);
                });

                updateCategoryDropdown();
                updateAdminCategoryFilter();
                displayProductsAdmin(adminProducts);
            }).catch(err => {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading products.</td></tr>';
            });
        }

        function displayProductsAdmin(products) {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = '';

            // Update the count badge
            document.getElementById('product-count-badge').textContent = `Total Products: ${products.length}`;

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No matching products found.</td></tr>';
                return;
            }

            products.forEach((p, index) => {
                renderProductRow(p.id, p, tbody, index + 1);
            });
        }

        function renderProductRow(id, p, container, rowNum) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${rowNum}</strong></td>
                <td><img src="${p.image}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;" onerror="this.src='images/default.jpg'"></td>
                <td>${p.name}</td>
                <td><span class="status-badge" style="background:#f3e5f5;color:#4a148c;border:none;">${p.category || 'General'}</span></td>
                <td>RM${parseFloat(p.price).toFixed(2)}</td>
                <td>
                    <button class="toggle-btn" onclick="editProduct('${id}')">Edit</button>
                    <button class="toggle-btn" style="color:red;border-color:red;" onclick="deleteProduct('${id}')">Delete</button>
                </td>
            `;
            container.appendChild(tr);
        }

        function filterProductsAdmin() {
            const searchTerm = document.getElementById('admin-product-search').value.toLowerCase();
            const categoryFilter = document.getElementById('admin-category-filter').value;
            const priceFilter = document.getElementById('admin-price-filter').value;
            const sortOrder = document.getElementById('admin-product-sort').value;

            let filtered = adminProducts.filter(p => {
                const matchesName = p.name.toLowerCase().includes(searchTerm);
                const matchesCategory = categoryFilter === 'all' || p.category === categoryFilter;

                let matchesPrice = true;
                const price = parseFloat(p.price);
                if (priceFilter === '0-5') matchesPrice = price < 5;
                else if (priceFilter === '5-10') matchesPrice = price >= 5 && price <= 10;
                else if (priceFilter === '10-20') matchesPrice = price > 10 && price <= 20;
                else if (priceFilter === '20') matchesPrice = price > 20;

                return matchesName && matchesCategory && matchesPrice;
            });

            // Apply Sorting
            if (sortOrder === 'price-low') {
                filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
            } else if (sortOrder === 'price-high') {
                filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
            } else if (sortOrder === 'name-asc') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            }

            displayProductsAdmin(filtered);
        }

        function updateAdminCategoryFilter() {
            const filter = document.getElementById('admin-category-filter');
            const currentValue = filter.value;
            filter.innerHTML = '<option value="all">All Categories</option>';
            [...allCategories].sort().forEach(cat => {
                if (cat) {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    filter.appendChild(opt);
                }
            });
            filter.value = currentValue; // Preserve selection if possible
        }

        function clearProductFilters() {
            document.getElementById('admin-product-search').value = '';
            document.getElementById('admin-category-filter').value = 'all';
            document.getElementById('admin-price-filter').value = 'all';
            document.getElementById('admin-product-sort').value = 'default';
            displayProductsAdmin(adminProducts);
        }

        // Product CRUD
        function openProductModal(editMode = false, product = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            const title = document.getElementById('modal-title');

            if (!editMode) {
                title.textContent = 'Add New Product';
                form.reset();
                document.getElementById('product-id').value = '';
            } else {
                title.textContent = 'Edit Product';
                document.getElementById('product-id').value = product.id;
                document.getElementById('p-name').value = product.name;
                document.getElementById('p-price').value = product.price;
                document.getElementById('p-image').value = product.image;
                document.getElementById('p-description').value = product.description;

                // Handle Category
                const catSelect = document.getElementById('p-category-select');
                if ([...catSelect.options].some(o => o.value === product.category)) {
                    catSelect.value = product.category;
                    document.getElementById('p-category-new').style.display = 'none';
                } else {
                    catSelect.value = 'new';
                    document.getElementById('p-category-new').style.display = 'block';
                    document.getElementById('p-category-new').value = product.category;
                }
            }
            modal.style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        function checkCategoryInput(select) {
            const input = document.getElementById('p-category-new');
            input.style.display = select.value === 'new' ? 'block' : 'none';
            if (select.value !== 'new') input.value = '';
        }

        function updateCategoryDropdown() {
            const select = document.getElementById('p-category-select');
            // Keep first two options (Select... and New...)
            select.innerHTML = '<option value="">Select Category...</option><option value="new">+ Type New Category</option>';
            allCategories.forEach(cat => {
                if (cat) {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    select.appendChild(opt);
                }
            });
        }

        document.getElementById('product-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const catSelect = document.getElementById('p-category-select');
            const category = catSelect.value === 'new' ? document.getElementById('p-category-new').value : catSelect.value;

            const data = {
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value),
                category: category,
                image: document.getElementById('p-image').value,
                description: document.getElementById('p-description').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const action = id ? db.collection("products").doc(id).update(data) : db.collection("products").add(data);

            action.then(() => {
                closeProductModal();
                fetchProducts();
            }).catch(err => alert("Error saving product: " + err.message));
        });

        function editProduct(id) {
            db.collection("products").doc(id).get().then(doc => {
                if (doc.exists) openProductModal(true, { id: doc.id, ...doc.data() });
            });
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                db.collection("products").doc(id).delete().then(() => fetchProducts());
            }
        }

        // 5. Vacancy Management
        async function fetchVacancies() {
            const tbody = document.getElementById('vacancies-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';

            try {
                // Get all applications to count them
                const appsSnap = await db.collection("applications").get();
                const counts = {};
                appsSnap.forEach(doc => {
                    const data = doc.data();
                    const pId = data.positionId;
                    if (pId) {
                        counts[pId] = (counts[pId] || 0) + 1;
                    }
                });

                const snap = await db.collection("vacancies").orderBy("createdAt", "desc").get();
                tbody.innerHTML = '';
                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No vacancies found.</td></tr>';
                    return;
                }
                snap.forEach(doc => {
                    const v = doc.data();
                    const waitCount = counts[doc.id] || 0;
                    renderVacancyRow(doc.id, v, tbody, waitCount);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color:red;">Error loading vacancies.</td></tr>';
            }
        }

        function renderVacancyRow(id, v, container, count) {
            const tr = document.createElement('tr');
            const isActive = v.status !== 'Closed';
            tr.innerHTML = `
                <td><strong>${v.title}</strong></td>
                <td>${v.type}</td>
                <td><div style="max-width:200px; max-height:60px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${v.description}</div></td>
                <td><span class="status-badge" style="background:#e8eaf6; color:#3f51b5;">${count} applied</span></td>
                <td><span class="status-badge ${isActive ? 'status-completed' : 'status-new'}" style="${!isActive ? 'background-color:#ffebee; color:#c62828;' : ''}">${isActive ? 'Active' : 'Closed'}</span></td>
                <td>
                    <button class="toggle-btn" onclick="editVacancy('${id}')">Edit</button>
                    <button class="toggle-btn" style="color:red;border-color:red;" onclick="deleteVacancy('${id}')">Delete</button>
                </td>
            `;
            container.appendChild(tr);
        }

        function openVacancyModal(editMode = false, vacancy = null) {
            const modal = document.getElementById('vacancy-modal');
            const form = document.getElementById('vacancy-form');
            const title = document.getElementById('vacancy-modal-title');

            if (!editMode) {
                title.textContent = 'Add New Vacancy';
                form.reset();
                document.getElementById('vacancy-id').value = '';
            } else {
                title.textContent = 'Edit Vacancy';
                document.getElementById('vacancy-id').value = vacancy.id;
                document.getElementById('v-title').value = vacancy.title;
                document.getElementById('v-type').value = vacancy.type;
                document.getElementById('v-description').value = vacancy.description;
                document.getElementById('v-status').value = vacancy.status || 'Active';
            }
            modal.style.display = 'block';
        }

        function closeVacancyModal() {
            document.getElementById('vacancy-modal').style.display = 'none';
        }

        document.getElementById('vacancy-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = document.getElementById('vacancy-id').value;
            const data = {
                title: document.getElementById('v-title').value,
                type: document.getElementById('v-type').value,
                description: document.getElementById('v-description').value,
                status: document.getElementById('v-status').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!id) {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            const action = id ? db.collection("vacancies").doc(id).update(data) : db.collection("vacancies").add(data);

            action.then(() => {
                closeVacancyModal();
                document.getElementById('vacancy-form').reset();
                fetchVacancies();
            }).catch(err => alert("Error saving vacancy: " + err.message));
        });

        function editVacancy(id) {
            db.collection("vacancies").doc(id).get().then(doc => {
                if (doc.exists) openVacancyModal(true, { id: doc.id, ...doc.data() });
            });
        }

        function deleteVacancy(id) {
            if (confirm("Delete this vacancy?")) {
                db.collection("vacancies").doc(id).delete().then(() => fetchVacancies());
            }
        }

        // 6. Applicants View
        function fetchApplicants() {
            const tbody = document.getElementById('applicants-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';

            db.collection("applications").orderBy("createdAt", "desc").get().then((snap) => {
                tbody.innerHTML = '';
                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No applications yet.</td></tr>';
                    return;
                }
                snap.forEach(doc => renderApplicantRow(doc.id, doc.data(), tbody));
            });
        }

        function renderApplicantRow(id, a, container) {
            let dateStr = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().toLocaleString() : 'N/A';
            const status = a.status || 'New';
            const isProcessed = status === 'Accepted' || status === 'Rejected';

            let statusStyle = 'background-color: #e3f2fd; color: #0d47a1;'; // Default New
            if (status === 'Accepted') statusStyle = 'background-color: #e8f5e9; color: #1b5e20; font-weight: bold;';
            if (status === 'Rejected') statusStyle = 'background-color: #ffebee; color: #c62828; font-weight: bold;';

            const tr = document.createElement('tr');
            if (isProcessed) tr.style.opacity = '0.5';

            tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${a.name}</td>
                <td><strong>${a.positionName || 'General'}</strong></td>
                <td>${a.phone}</td>
                <td>${a.college}</td>
                <td>${a.transport}</td>
                <td><span class="status-badge" style="${statusStyle}">${status.toUpperCase()}</span></td>
                <td>
                    ${!isProcessed ? `
                        <button class="toggle-btn" style="color:green; border-color:green;" onclick="updateApplicantStatus('${id}', 'Accepted')">Accept</button>
                        <button class="toggle-btn" style="color:red; border-color:red;" onclick="updateApplicantStatus('${id}', 'Rejected')">Reject</button>
                    ` : `
                        <button class="toggle-btn" style="color:#666; border-color:#999;" onclick="deleteApplicant('${id}')">Delete</button>
                    `}
                </td>
            `;
            container.appendChild(tr);
        }

        function deleteApplicant(id) {
            if (confirm("Delete this application record?")) {
                db.collection("applications").doc(id).delete().then(() => fetchApplicants());
            }
        }

        function updateApplicantStatus(id, newStatus) {
            if (confirm(`Set applicant status to ${newStatus}?`)) {
                db.collection("applications").doc(id).get().then(doc => {
                    const data = doc.data();

                    db.collection("applications").doc(id).update({
                        status: newStatus
                    }).then(() => {
                        if (newStatus === 'Accepted') {
                            // Automatically add to staff
                            const staffData = {
                                applicantId: id,
                                name: data.name,
                                phone: data.phone,
                                transport: data.transport,
                                college: data.college,
                                position: data.positionName || 'General',
                                joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                status: 'Active'
                            };
                            db.collection("staff").add(staffData).then(() => {
                                fetchApplicants();
                            });
                        } else {
                            fetchApplicants();
                        }
                    });
                });
            }
        }

        // 7. Staff Management
        function fetchStaff() {
            const tbody = document.getElementById('staff-table-body');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

            db.collection("staff").orderBy("joinedAt", "desc").get().then((snap) => {
                tbody.innerHTML = '';
                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No staff found.</td></tr>';
                    return;
                }
                snap.forEach(doc => renderStaffRow(doc.id, doc.data(), tbody));
            });
        }

        function renderStaffRow(id, s, container) {
            let joinedStr = s.joinedAt && s.joinedAt.toDate ? s.joinedAt.toDate().toLocaleDateString() : 'N/A';
            let dismissedStr = s.dismissedAt && s.dismissedAt.toDate ? s.dismissedAt.toDate().toLocaleDateString() : '-';
            const isActive = s.status === 'Active';

            const tr = document.createElement('tr');
            if (!isActive) tr.style.opacity = '0.4';

            tr.innerHTML = `
                <td><strong>${s.name}</strong></td>
                <td>${s.phone}</td>
                <td>${s.transport}</td>
                <td>${s.college}</td>
                <td>${s.position}</td>
                <td>${joinedStr}</td>
                <td>${isActive ? '-' : `<div>${dismissedStr}</div><small style="color:#666;">Reason: ${s.dismissalReason || 'N/A'}</small>`}</td>
                <td>
                    ${isActive ? `<button class="toggle-btn" style="color:red; border-color:red;" onclick="dismissStaff('${id}')">Dismiss</button>` : '<span style="color:#666;">Inactive</span>'}
                </td>
            `;
            container.appendChild(tr);
        }

        function dismissStaff(id) {
            const reason = prompt("Enter dismissal reason:");
            if (reason === null) return; // Cancelled
            if (!reason.trim()) {
                alert("Reason is required.");
                return;
            }

            if (confirm("Are you sure you want to dismiss this staff?")) {
                db.collection("staff").doc(id).update({
                    status: 'Dismissed',
                    dismissalReason: reason,
                    dismissedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => fetchStaff());
            }
        }
    </script>
</body>

</html>